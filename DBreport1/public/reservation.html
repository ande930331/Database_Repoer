<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é ç´„çœ‹è»Šç¢ºèª</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f0f2f5; padding: 40px 20px; }
        .container { 
            max-width: 700px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            overflow: hidden;
        }
        
        /* æ¨™é¡Œå€å¡Š */
        .header { background: #333; color: white; padding: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.5em; letter-spacing: 1px; }

        /* å…§å®¹å€å¡Š */
        .content { padding: 30px; }

        /* è»Šè¼›è³‡è¨Šå¡ (ç¾åŒ–ç‰ˆ) */
        .moto-card { 
            display: flex; 
            background: #fff; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 25px; 
            align-items: center;
        }
        .moto-img { 
            width: 160px; height: 110px; 
            object-fit: cover; 
            border-radius: 6px; 
            margin-right: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .moto-info h3 { margin: 0 0 5px 0; color: #333; font-size: 1.3em; }
        .tag { 
            display: inline-block; background: #eef2f6; color: #555; 
            font-size: 0.85em; padding: 2px 8px; border-radius: 4px; margin-right: 5px; 
        }
        .price { color: #d00; font-weight: bold; font-size: 1.4em; margin-top: 8px; display: block; }

        /* è¡¨å–®æ¨£å¼ */
        .section-title { 
            font-size: 1em; color: #666; margin-bottom: 10px; font-weight: bold; 
            border-left: 4px solid #007bff; padding-left: 10px;
        }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #444; }
        
        input, textarea { 
            width: 100%; padding: 12px; 
            border: 1px solid #ddd; border-radius: 6px; 
            box-sizing: border-box; font-size: 16px; 
            transition: border 0.3s;
        }
        input:focus, textarea:focus { border-color: #007bff; outline: none; }
        
        /* å”¯è®€æ¬„ä½æ¨£å¼ */
        input[readonly] { background-color: #f9f9f9; color: #777; cursor: not-allowed; }

        textarea { height: 100px; resize: vertical; }

        /* æŒ‰éˆ•å€ */
        .btn-submit { 
            width: 100%; padding: 15px; 
            background: #28a745; color: white; 
            border: none; border-radius: 6px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: all 0.2s; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
        }
        .btn-submit:hover { background: #218838; transform: translateY(-2px); }
        
        .back-link { 
            display: block; text-align: center; margin-top: 20px; 
            color: #666; text-decoration: none; font-size: 0.9em; 
        }
        .back-link:hover { color: #333; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>é ç´„çœ‹è»Šç¢ºèª</h1>
        </div>

        <div class="content">
            <div class="moto-card">
                <img id="motoImg" class="moto-img" src="" alt="è»Šè¼›åœ–ç‰‡">
                <div class="moto-info">
                    <h3 id="motoTitle">è¼‰å…¥ä¸­...</h3>
                    <div>
                        <span class="tag" id="motoYear">--å¹´</span>
                        <span class="tag" id="motoLicense">--</span>
                    </div>
                    <span class="price" id="motoPrice">...</span>
                </div>
            </div>

            <form id="reserveForm">
                <input type="hidden" id="motoId">
                
                <div class="form-group">
                    <div class="section-title">è¯çµ¡äººè³‡è¨Š (è‡ªå‹•å¸¶å…¥)</div>
                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label>é ç´„å¤§å</label>
                            <input type="text" id="userName" readonly>
                        </div>
                        <div style="flex: 1;">
                            <label>è¯çµ¡é›»è©±</label>
                            <input type="text" id="userPhone" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="section-title">é ç´„è©³æƒ…</div>
                    <label>çœ‹è»Šæ™‚é–“</label>
                    <input type="datetime-local" id="reserveTime" required>
                    <small style="color:#888; font-size:0.85em;">* æˆ‘å€‘æœƒä¾æ­¤æ™‚é–“å®‰æ’ï¼Œè‹¥æœ‰è®Šå‹•æœƒä¸»å‹•è¯ç¹«æ‚¨ã€‚</small>
                </div>

                <div class="form-group">
                    <label>ğŸ’¬ å‚™è¨» / æƒ³å•çš„å•é¡Œ (é¸å¡«)</label>
                    <textarea id="reserveNote" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è©¦è½å¼•æ“è²æµªã€æƒ³äº†è§£è²¸æ¬¾æ–¹æ¡ˆ..."></textarea>
                </div>

                <button type="submit" class="btn-submit">ç¢ºèªé€å‡ºé ç´„</button>
            </form>

            <a href="index.html" class="back-link">â† å–æ¶ˆï¼Œå›åˆ°é¦–é </a>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const motoId = params.get('id');

        if (!motoId) {
            alert('åƒæ•¸éŒ¯èª¤ï¼Œå›åˆ°é¦–é ');
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. æª¢æŸ¥ç™»å…¥ & å–å¾—ä½¿ç”¨è€…è³‡æ–™
            const authRes = await fetch('/api/me');
            const authData = await authRes.json();
            
            if (!authData.loggedIn) {
                alert('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½é€²è¡Œé ç´„ï¼');
                window.location.href = 'login.html';
                return;
            }

            // ğŸŸ¢ å¡«å…¥ä½¿ç”¨è€…è³‡è¨Š (è®“ä½¿ç”¨è€…å®‰å¿ƒ)
            document.getElementById('userName').value = authData.user.name;
            document.getElementById('userPhone').value = authData.user.phone || 'æœªå¡«å¯«';

            // ğŸŸ¢ è¨­å®šæ—¥æœŸé™åˆ¶ (ä¸èƒ½é¸éå»çš„æ™‚é–“)
            const now = new Date();
            // æ ¼å¼åŒ–ç‚º YYYY-MM-DDTHH:MM (datetime-local éœ€è¦çš„æ ¼å¼)
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('reserveTime').min = now.toISOString().slice(0, 16);


            // 2. è¼‰å…¥è»Šè¼›è³‡æ–™
            const res = await fetch(`/api/motorcycles/${motoId}`);
            if (!res.ok) {
                alert('æ‰¾ä¸åˆ°è©²è»Šè¼›è³‡æ–™');
                window.location.href = 'index.html';
                return;
            }
            const car = await res.json();

            // 3. æ¸²æŸ“è»Šè¼›å¡ç‰‡
            document.getElementById('motoId').value = car.moto_id;
            document.getElementById('motoTitle').textContent = `${car.brand} ${car.model}`;
            document.getElementById('motoYear').textContent = `${car.year || '----'}å¹´`;
            document.getElementById('motoLicense').textContent = car.license_name;
            document.getElementById('motoPrice').textContent = `$${car.price.toLocaleString()}`;
            
            if (car.image_url) {
                document.getElementById('motoImg').src = car.image_url;
            } else {
                document.getElementById('motoImg').src = 'https://via.placeholder.com/150x100?text=No+Image';
            }
        });

        // 4. é€å‡ºè¡¨å–®
        document.getElementById('reserveForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                moto_id: document.getElementById('motoId').value,
                reserve_time: document.getElementById('reserveTime').value,
                note: document.getElementById('reserveNote').value
            };

            const res = await fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (data.success) {
                alert('ğŸ‰ é ç´„æˆåŠŸï¼\n\nè³£å®¶å°‡æœƒæ”¶åˆ°æ‚¨çš„é€šçŸ¥ï¼Œè«‹ç•™æ„æ‚¨çš„é›»è©±ã€‚');
                window.location.href = 'index.html';
            } else {
                alert('é ç´„å¤±æ•—ï¼š' + data.message);
            }
        });
    </script>
</body>
</html>