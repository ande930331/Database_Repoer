<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æœƒå“¡ä¸­å¿ƒ</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f4f4f4; }
        nav { background: #333; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        .card { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; border-bottom: 2px solid #f4f4f4; padding-bottom: 15px; color: #333; }
        .profile-info p { font-size: 1.1em; color: #555; margin: 10px 0; }
        .profile-info strong { color: #333; width: 100px; display: inline-block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #666; font-weight: bold; }
        .thumb-img { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 10px; }
        .status-pending { color: orange; font-weight: bold; background: #fff8e1; padding: 4px 8px; border-radius: 4px; }
        .status-confirmed { color: green; font-weight: bold; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; }
        .status-canceled { color: #999; background: #eee; padding: 4px 8px; border-radius: 4px; }
        a { color: white; text-decoration: none; margin-left: 15px; }
        .btn-home { background: #007bff; padding: 5px 15px; border-radius: 4px; }
        .btn-cancel { background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9em; margin-top:5px; }
        .btn-edit-user { background:#007bff; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9em; margin-top:5px; margin-right:5px; }
    </style>
</head>
<body>
    <nav>
        <div style="font-size: 1.5em; font-weight:bold;">ğŸï¸ MotoMarket</div>
        <div><a href="index.html" class="btn-home">å›é¦–é </a><a href="#" onclick="logout()">ç™»å‡º</a></div>
    </nav>
    <div class="container">
        <div class="card">
            <h2>ğŸ‘¤ æˆ‘çš„å€‹äººè³‡æ–™</h2>
            <div class="profile-info">
                <p><strong>å§“åï¼š</strong> <span id="myName">...</span></p>
                <p><strong>é›»è©±ï¼š</strong> <span id="myPhone">...</span></p>
                <p><strong>èº«åˆ†ï¼š</strong> <span id="myRole">ä¸€èˆ¬æœƒå“¡</span></p>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ“… æˆ‘çš„é ç´„ç´€éŒ„</h2>
            <table id="myResTable"><thead><tr><th>é ç´„è»Šè¼›</th><th>é ç´„æ™‚é–“</th><th>å‚™è¨»</th><th>ç‹€æ…‹</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="memberEditModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
        <div style="background:white; padding:25px; border-radius:8px; width:90%; max-width:400px; position:relative;">
            <span onclick="document.getElementById('memberEditModal').style.display='none'" style="position:absolute; right:15px; top:10px; cursor:pointer; font-size:24px;">&times;</span>
            <h2 style="margin-top:0;">âœï¸ ä¿®æ”¹é ç´„è³‡è¨Š</h2>
            <form id="memberEditForm">
                <input type="hidden" id="mem_res_id">
                
                <label style="display:block; margin:10px 0 5px; font-weight:bold;">ğŸ“… é ç´„æ™‚é–“</label>
                <input type="datetime-local" id="mem_res_time" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <small id="time_locked_hint" style="display:none; color:red; margin-top:5px;">âš ï¸ å·²ç¢ºèªçš„é ç´„ç„¡æ³•æ›´æ”¹æ™‚é–“ï¼Œå¦‚éœ€æ”¹æœŸè«‹ç•™è¨€ã€‚</small>
                
                <label style="display:block; margin:10px 0 5px; font-weight:bold;">ğŸ’¬ ç•™è¨€ / å‚™è¨»</label>
                <textarea id="mem_res_note" style="width:100%; height:80px; padding:8px; border:1px solid #ddd; border-radius:4px;" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³æ”¹çœ‹åˆ¥å°è»Šã€é‚£å¤©æœƒæ™šé»åˆ°..."></textarea>
                <button type="submit" style="width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:4px; margin-top:15px; cursor:pointer;">é€å‡ºè¨Šæ¯</button>
            </form>
        </div>
    </div>

    <script>
        fetch('/api/me').then(res => res.json()).then(data => {
            if (!data.loggedIn) { alert('è«‹å…ˆç™»å…¥'); window.location.href = 'login.html'; return; }
            document.getElementById('myName').textContent = data.user.name;
            document.getElementById('myPhone').textContent = data.user.phone || 'æœªå¡«å¯«';
            document.getElementById('myRole').textContent = data.user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬è²·å®¶';
            loadMyReservations();
        });
        function logout() { fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = 'index.html'); }
        async function loadMyReservations() {
            const res = await fetch('/api/my/reservations');
            const list = await res.json();
            const tbody = document.querySelector('#myResTable tbody');
            tbody.innerHTML = '';
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">ç„¡é ç´„ç´€éŒ„</td></tr>'; return; }
            list.forEach(item => {
                const tr = document.createElement('tr');
                let statusHtml = '', actionBtn = '';
                if(item.status === 'pending') {
                    statusHtml = '<span class="status-pending">â³ ç­‰å¾…ç¢ºèª</span>';
                    actionBtn = `<br><button onclick="openMemberEdit(${item.reserve_id}, '${item.reserve_time}', '${item.note||''}', false)" class="btn-edit-user">ä¿®æ”¹/ç•™è¨€</button><button onclick="cancelMyRes(${item.reserve_id})" class="btn-cancel">å–æ¶ˆ</button>`;
                } else if(item.status === 'confirmed') {
                    statusHtml = '<span class="status-confirmed">âœ… é ç´„æˆåŠŸ</span>';
                    // ğŸŸ¢ å·²ç¢ºèªï¼šå‚³å…¥ true é–å®šæ™‚é–“
                    actionBtn = `<br><button onclick="openMemberEdit(${item.reserve_id}, '${item.reserve_time}', '${item.note||''}', true)" class="btn-edit-user" style="background:#28a745;">ç•™è¨€/è¯ç¹«</button>`;
                } else {
                    statusHtml = '<span class="status-canceled">âŒ å·²å–æ¶ˆ</span>';
                }
                const imgUrl = item.image_url || 'https://via.placeholder.com/50';
                const timeStr = new Date(item.reserve_time).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                tr.innerHTML = `<td><img src="${imgUrl}" class="thumb-img"><b>${item.brand} ${item.model}</b></td><td style="font-size:1.1em;">${timeStr}</td><td style="color:#666;">${item.note || '-'}${actionBtn}</td><td>${statusHtml}</td>`;
                tbody.appendChild(tr);
            });
        }
        function openMemberEdit(id, timeStr, note, isLocked) {
            document.getElementById('mem_res_id').value = id;
            const dt = new Date(timeStr); dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            const timeInput = document.getElementById('mem_res_time');
            timeInput.value = dt.toISOString().slice(0, 16);
            
            // ğŸŸ¢ é–å®šé‚è¼¯
            if (isLocked) {
                timeInput.disabled = true;
                timeInput.style.backgroundColor = "#e9ecef";
                document.getElementById('time_locked_hint').style.display = 'block';
            } else {
                timeInput.disabled = false;
                timeInput.style.backgroundColor = "white";
                document.getElementById('time_locked_hint').style.display = 'none';
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                timeInput.min = now.toISOString().slice(0, 16);
            }

            document.getElementById('mem_res_note').value = note;
            document.getElementById('memberEditModal').style.display = 'flex';
        }
        document.getElementById('memberEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('mem_res_id').value;
            const res = await fetch(`/api/my/reservations/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ reserve_time: document.getElementById('mem_res_time').value, note: document.getElementById('mem_res_note').value }) });
            if(res.ok) { alert(res.message || 'æ“ä½œæˆåŠŸï¼'); document.getElementById('memberEditModal').style.display = 'none'; loadMyReservations(); } 
            else { alert('æ“ä½œå¤±æ•—'); }
        });
        async function cancelMyRes(id) { if(!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return; const res = await fetch(`/api/my/reservations/${id}/cancel`, { method: 'PUT' }); if(await res.json().then(d=>d.success)) { alert('å·²å–æ¶ˆ'); loadMyReservations(); } }
    </script>
</body>
</html>