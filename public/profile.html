<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æœƒå“¡ä¸­å¿ƒ</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f4f4f4; }
        nav { background: #333; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        .card { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; border-bottom: 2px solid #f4f4f4; padding-bottom: 15px; color: #333; }
        .profile-info p { font-size: 1.1em; color: #555; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #666; font-weight: bold; }
        a { color: white; text-decoration: none; margin-left: 15px; }
        .btn-home { background: #007bff; padding: 5px 15px; border-radius: 4px; }
        
        button { border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; color: white; font-size: 13px; margin-right: 5px; margin-bottom: 3px; }
        .btn-msg { background: #17a2b8; }
        .btn-edit { background: #007bff; }
        .btn-cancel { background: #dc3545; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }

        /* èŠå¤©å®¤ */
        .msg-row { margin-bottom: 8px; display: flex; flex-direction: column; }
        .msg-bubble { padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .my-msg { align-items: flex-end; }
        .my-msg .msg-bubble { background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .other-msg { align-items: flex-start; }
        .other-msg .msg-bubble { background: #e9ecef; color: black; border-bottom-left-radius: 2px; }
    </style>
</head>
<body>
    <nav>
        <div style="font-size: 1.5em; font-weight:bold;">ğŸï¸ MotoMarket</div>
        <div><a href="index.html" class="btn-home">å›é¦–é </a><a href="#" onclick="logout()">ç™»å‡º</a></div>
    </nav>
    <div class="container">
        <div class="card">
            <h2>ğŸ‘¤ æˆ‘çš„å€‹äººè³‡æ–™</h2>
            <div class="profile-info">
                <p><strong>å§“åï¼š</strong> <span id="myName">...</span></p>
                <p><strong>é›»è©±ï¼š</strong> <span id="myPhone">...</span></p>
                <p><strong>èº«åˆ†ï¼š</strong> <span id="myRole">ä¸€èˆ¬æœƒå“¡</span></p>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ“… æˆ‘çš„é ç´„ç´€éŒ„</h2>
            <table id="myResTable"><thead><tr><th>è»Šè¼›</th><th>æ™‚é–“</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">âœï¸ ä¿®æ”¹é ç´„</h3>
            <form id="editForm">
                <input type="hidden" id="edit_res_id">
                
                <label style="display:block; margin-bottom:5px; font-weight:bold;">æ›´æ›è»Šè¼›ï¼š</label>
                <select id="edit_moto_id" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
                    <option value="" disabled>è¼‰å…¥ä¸­...</option>
                </select>

                <label style="display:block; margin-bottom:5px; font-weight:bold;">é ç´„æ™‚é–“ï¼š</label>
                <input type="datetime-local" id="edit_time" required style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
                
                <label style="display:block; margin-bottom:5px; font-weight:bold;">å‚™è¨»ï¼š</label>
                <textarea id="edit_note" style="width:100%; height:60px; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;"></textarea>
                
                <button type="submit" class="btn-edit" style="width:100%; padding:10px;">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <div id="chatModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('chatModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">ğŸ’¬ è¯ç¹«ç®¡ç†å“¡</h3>
            <div id="chatBox" style="height:250px; overflow-y:scroll; border:1px solid #ddd; padding:10px; margin-bottom:10px; background:#f9f9f9;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
                <button onclick="sendMessage()" class="btn-msg">å‚³é€</button>
            </div>
        </div>
    </div>

    <script>
        let currentResId = null; 
        
        // 1. åˆå§‹åŒ–
        fetch('/api/me').then(res => res.json()).then(data => {
            if (!data.loggedIn) { alert('è«‹å…ˆç™»å…¥'); window.location.href = 'login.html'; return; }
            document.getElementById('myName').textContent = data.user.name;
            document.getElementById('myPhone').textContent = data.user.phone || 'æœªå¡«å¯«';
            document.getElementById('myRole').textContent = data.user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬è²·å®¶';
            loadMyReservations();
        });

        function logout() { fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = 'index.html'); }

        // 2. è¼‰å…¥åˆ—è¡¨
        async function loadMyReservations() {
            const res = await fetch('/api/my/reservations');
            const list = await res.json();
            const tbody = document.querySelector('#myResTable tbody');
            tbody.innerHTML = '';
            
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">ç„¡é ç´„ç´€éŒ„</td></tr>'; return; }
            
            list.forEach(item => {
                const tr = document.createElement('tr');
                let statusStr = '';
                let actionButtons = `<button onclick="openChat(${item.reserve_id})" class="btn-msg">ğŸ’¬ è¨Šæ¯</button>`;

                if (item.status === 'pending') {
                    statusStr = '<span style="color:orange; font-weight:bold;">â³ å¾…ç¢ºèª</span>';
                    // ğŸŸ¢ å‚³å…¥ currentMotoId (item.moto_id)
                    actionButtons += `<button onclick="openEdit(${item.reserve_id}, '${item.reserve_time}', '${item.note||''}', ${item.moto_id}, '${item.brand} ${item.model}')" class="btn-edit">âœï¸ ä¿®æ”¹</button>`;
                    actionButtons += `<button onclick="cancelMyRes(${item.reserve_id})" class="btn-cancel">ğŸš« å–æ¶ˆ</button>`;
                } else if (item.status === 'confirmed') {
                    statusStr = '<span style="color:green; font-weight:bold;">âœ… å·²ç¢ºèª</span>';
                } else {
                    statusStr = '<span style="color:gray;">âŒ å·²å–æ¶ˆ</span>';
                }

                tr.innerHTML = `
                    <td>${item.brand} ${item.model}</td>
                    <td>${new Date(item.reserve_time).toLocaleString()}</td>
                    <td>${statusStr}</td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(tr);
            });
        }

// ğŸŸ¢ ä¿®å¾©ç‰ˆï¼šå–æ¶ˆé ç´„å‡½å¼
async function cancelMyRes(id) {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ')) return;

    try {
        const res = await fetch(`/api/my/reservations/${id}/cancel`, { 
            method: 'PUT' 
        });
        
        // å…ˆè®€å–å›æ‡‰
        const result = await res.json();

        if (result.success) {
            alert('âœ… é ç´„å·²æˆåŠŸå–æ¶ˆï¼');
            loadMyReservations(); // é‡æ–°æ•´ç†åˆ—è¡¨
        } else {
            // é¡¯ç¤ºå¾Œç«¯å‚³å›ä¾†çš„å…·é«”éŒ¯èª¤è¨Šæ¯
            alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        console.error(error);
        alert('âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}

        // ğŸŸ¢ 4. æ‰“é–‹ä¿®æ”¹è¦–çª— (å«è¼‰å…¥å¯æ›è»Šè¼›)
        async function openEdit(id, timeStr, note, currentMotoId, currentMotoName) {
            document.getElementById('edit_res_id').value = id;
            
            // æ™‚é–“è™•ç†
            const dt = new Date(timeStr);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            document.getElementById('edit_time').value = dt.toISOString().slice(0, 16);
            document.getElementById('edit_note').value = note;

            // ğŸŸ¢ è¼‰å…¥è»Šè¼›é¸å–®
            const select = document.getElementById('edit_moto_id');
            select.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
            
            // æŠ“å–æ‰€æœ‰è»Šè¼›
            const res = await fetch('/api/motorcycles');
            const allCars = await res.json();
            select.innerHTML = '';
            
            // 1. å…ˆåŠ å…¥ã€Œç›®å‰é ç´„çš„é€™å°ã€(å¿…é¸)
            let currentOpt = document.createElement('option');
            currentOpt.value = currentMotoId;
            currentOpt.text = `(ç›®å‰) ${currentMotoName}`;
            currentOpt.selected = true;
            select.appendChild(currentOpt);

            // 2. åŠ å…¥å…¶ä»–ã€Œä¸Šæ¶ä¸­ (Available)ã€çš„è»Š
            allCars.forEach(car => {
                if (car.status === 'available' && car.moto_id !== currentMotoId) {
                    let opt = document.createElement('option');
                    opt.value = car.moto_id;
                    opt.text = `${car.brand} ${car.model} ($${car.price.toLocaleString()})`;
                    select.appendChild(opt);
                }
            });

            document.getElementById('editModal').style.display = 'flex';
        }

        // ğŸŸ¢ 5. é€å‡ºä¿®æ”¹ (å« moto_id)
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit_res_id').value;
            const payload = {
                moto_id: document.getElementById('edit_moto_id').value, // æ–°å¢
                reserve_time: document.getElementById('edit_time').value,
                note: document.getElementById('edit_note').value
            };
            
            const res = await fetch(`/api/my/reservations/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                alert('ä¿®æ”¹æˆåŠŸï¼');
                document.getElementById('editModal').style.display = 'none';
                loadMyReservations();
            } else {
                alert('ä¿®æ”¹å¤±æ•—');
            }
        });

        // 6. èŠå¤©å®¤åŠŸèƒ½
        function openChat(id) {
            currentResId = id;
            loadMessages(id);
            document.getElementById('chatModal').style.display = 'flex';
        }

        async function loadMessages(id) {
            const box = document.getElementById('chatBox');
            box.innerHTML = '<div style="text-align:center;">è¼‰å…¥ä¸­...</div>';
            const res = await fetch(`/api/reservations/${id}/messages`);
            const msgs = await res.json();
            box.innerHTML = '';
            if(msgs.length===0){ box.innerHTML = '<div style="text-align:center; color:#ccc;">ç„¡è¨Šæ¯</div>'; return; }
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = 'msg-row';
                div.classList.add(m.sender_role === 'buyer' ? 'my-msg' : 'other-msg');
                div.innerHTML = `<div class="msg-bubble">${m.content}</div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            if(!input.value.trim()) return;
            await fetch(`/api/reservations/${currentResId}/messages`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content:input.value})
            });
            input.value=''; loadMessages(currentResId);
        }
    </script>
</body>
</html>